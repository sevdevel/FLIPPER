---
runtime: shiny
output: html_document
#output: pdf_document
bibliography: "DOC/FLIPPERDOC.bib"
title: "FLIPPER: Flexible Interpretation of Porewater Profiles and Estimation of Rates"
---

<center>
![Logo](DOC/FLIPPERDOC_Figures/Logo_FLIPPER.png)
</center>

```{r, eval=T, echo=F}
load("datasets to test/output.example.Rdata", envir = knitr::knit_global())
```

# Introduction

FLIPPER (short for: FLexible Interpretation of Porewater Profiles and Estimation of Rates) has been created to provide a flexible way to analyze porewater data in sediments, continuing from the initial work of [@Berg1998]. The goal is to be able to extract fluxes in/out of the sediment, and net production or consumption rates from a vertical porewater profile. FLIPPER provides three different ways to analyze porewater data:

* calculation of a diffusive flux
* fitting of a simple diagenetic profile (cfr [@Berg1998])
* calculation of the first and second derivatives of a concentration profile

All three of these methods are combined in a simple R-function *FLIPPER_func*. In this manual, we will go through all three approaches and show how they can be calculated using FLIPPER.

# Preparatory steps
## Preparing your R environment

The first step is tosource the two main functions
```{r}
source("user interface function.R", local = knitr::knit_global())
source("FLIPPER_plotfunction.R", local = knitr::knit_global())
```

## The FLIPPER function
We can take a quick first look at the syntax of the FLIPPER function (but we will go in more depth later)
```{r, eval=F, echo=T}
FLIPPER.func(input,species,por.cte=NA,E.cte=NULL,tort.dep=1,method=NULL,env.parms=NULL,full.output=FALSE,
             # optional input for gradient
             gradient.parms=NULL
             # optional input for discrete
             discrete.parms=NULL,
             # optional input for continuous
             continuous.parms=NULL,
             )
```
We can see that FLIPPER requires **input** (your data) and **species** (which element are you analyzing), and can optionally be supplied with porosity (**por.cte**), electrical field (**E.cte**), a choice of tortuosity (**tort.dep**, more on that later), which method (**method**), a set of environmental parameters (**env.parms**), whether you want all possible output (**full.output**). Finally there is also the possibility to supply specific parameters for each of the three analysis methods (**gradient.parms**, **discrete.parms**, **continuous.parms**). Through a series of example analyses of porewater profiles, we will discuss the different types of input, how to use FLIPPER, and part of the theory behind FLIPPER.

## Preparing a dataset
Now we want to load a dataset to work with 
```{r}
load("datasets to test/O2_testprofiles.RData", envir = knitr::knit_global())
```

This will load three different O2 profile, called *profile.A*, *profile.B* and *profile.C*. All three of them are dataframes, and have an identical structure. You can look at the top of profile.A
```{r}
head(profile.A)
```
You will notice there are 8 different columns. These three oxygen profiles are artificially generated, which means we have applied a depth-dependent reaction rate, and calculated the concentration and transport profiles. Hence, the columns **C.true**, **J.true** and **R.true** are the simulated profiles. Afterwards we have added noise to the data (column **C**), and have generated an artificial oxygen profile. For the purpose of this exercise, we only have to look at columns **x** and **C**. Column **x** represents the depth (in centimeters) and column **C** the concentration (in mM). You can imagine this is data generated by analyzing oxygen in marine sediments using microsensor profiling. 
The units of FLIPPER are $m$ (for **x**) and $mmol \: m^{-3}$ (for **C**). The first thing we have to do is to create a dataframe **input** with the right columns (and with the data in the right units), so it can be analyzed by FLIPPER. 
```{r}
input.profile <- as.data.frame(cbind(profile.A$C*1e3,profile.A$x*1e-2))
colnames(input.profile) <- c('C','x')
```
The resulting input dataframe then looks like this (negative depths are values in the watercolumn)
```{r}
head(input.profile)
```

The next thing we have to tell FLIPPER are the environmental conditions in which we measured our porewater profiles. For our case, this would be 10.0 $° C$ for the temperature (**TC**) and 35.0 for the salinity (**S**). So we make a list with those values.
```{r}
env.parms <- list(TC=10.0,S=35.0)
```
And finally, we have to supply the porosity of the sediment. This can be done directly in the **input** dataframe, if we have a depth-dependent porosity profile, or as a constant value. Since the porosity will not vary much over the first 0.5 cm of the sediment, we can just supply a constant value.
```{r}
por.cte <- 0.8
```
Now we have the essential data to analyze our porewater $O_2$ profile. Let's start using FLIPPER.

# The gradient method
We supply our **input** dataframe, **por.cte** value and **env.parms** list to FLIPPER, and indicate we are analyzing an oxygen profile (c("O2") in the FLIPPER function). The *plot.FLIPPER(test)* call will plot the result of the analysis. 
```{r, eval=F, echo=T}
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte,tort.dep=1, 
                         env.parms=env.parms,
                         method="gradient")
    plot.FLIPPER(test)
```
Once we run FLIPPER via the action button below, a pop-up window will appear and ask us to select the two points between which we want to calculate the diffusive flux. To calculate a gradient, we need to fit a linear model through the concentration versus depth plot. The slope of this fit then gives us the concentration gradient. To have a robust estimate of the slope, it is important to select at least 3 points (and preferably more) points. Let's first select the first four points on the concentration profile (so the four points closest to the sediment-water interface).
Whenever you are ready, press the button below to run FLIPPER.

```{r, eval=F, echo=T}
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         method="gradient")
    plot.FLIPPER(test)
```
```{r, eval=T, echo=F}
actionButton("action", label = "Run gradient FLIPPER")
renderPlot({
  if(input$action>=1){
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         method="gradient")
    plot.FLIPPER(test)
  } 

}) 
```

If all went well, FLIPPER calculated for us a diffusive oxygen flux of 8.012 $mmol \: m^{-2} \: d^{-1}$ (*R.int* on the plot, the minus indicates consumption; see below for a bit more discussion about the relation between *R.int* and fluxes). The red line indicates the linear fit through the selected points. The gradient method in FLIPPER calculates the diffusive flux following Fick's first law of diffusion [@Fick1855]; 

$$
J_{D}= -\phi D_S \frac{\delta C}{\delta x} 
$$
from which you can see you need the porosity ($\phi$), an effective diffusion coefficient (calculated by FLIPPER using the *diffcoef* function of CRAN:marelac from the supplied salinity and temperature) and the concentration gradient (calculated between the points you indicated on the plot, using the *lm* function from R). The effective diffusion coefficient in the sediment can be calculated as
$$
D_S=\frac{D_0(S,T)}{\theta^2}
$$
where $\theta^2$ is the tortuosity. Tortuosity is a correction for the effective pathlength because in sediments, a dissolved compound cannot diffuse in straight way, because particles block its way (see [@Boudreau1997] for many more details). Tortuosity can be estiated from porosity. By default (if **tort.dep** = 1), the tortuosity is calculated as [@Boudreau1996a]
$$
  \theta^2=1-2ln(\phi)
$$
Other options exist; $\theta^2=\phi^{-1}$ (**tort.dep**=2), $\theta^2=\phi^{-2}$ (**tort.dep**=3), $\theta^2=1+3(1-\phi)$ (**tort.dep**=4), should you desire another tortuosity calculation.

An alternative way of calculating an oxygen flux into the sediment is by calculating the diffusive oxygen flux in the water column, through the so-called Diffusive Boundary Layer. In this layer just above the sediment-water interface, advection is not efficient, and diffusion is the dominant transport pathway for dissolved substances. For more in depth reading about the DBL and its impact on O2 fluxes, you can refer to [@Jorgensen1990] and many other publications on this subject.
For now, all you need to know is that the flux of O2 through the DBL should be equal to the flux of O2 into the sediment. We can test this by running FLIPPER again, and this time select the first point just above the SWI, and the 6th point above the SWI (where the constant concentration of O2 starts decreasing).

```{r, eval=F, echo=T}
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         method="gradient")
    plot.FLIPPER(test)
```
```{r, eval=T, echo=F}
actionButton("action2", label = "Run gradient FLIPPER")
renderPlot({
  if(input$action2>=1){
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         method="gradient")
    plot.FLIPPER(test)
  } 
}) 
```

If all went well, FLIPPER calculated for us a diffusive oxygen flux of 7.536 $mmol \: m^{-2} \: d^{-1}$, which, given the uncertainty associated with the measurements, is pretty close to the oxygen flux estimated from the first sediment layer.
Let's run FLIPPER again, and this time we will select a point just below the sediment-water interface, and one near the bottom of the concentration profile (just for illustrative purposes)

```{r, eval=F, echo=T}
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         method="gradient")
    plot.FLIPPER(test)
```
```{r, eval=T, echo=F}
actionButton("action3", label = "Run gradient FLIPPER")
renderPlot({
  if(input$action3>=1){
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         method="gradient")
    plot.FLIPPER(test)
    } 
}) 
```
You will notice that the red line this time does not go through the points. This is because FLIPPER is trying to fit a linear model through all the points between the two selected by the user. You will thus have to be careful if your profile contains outliers (e.g. that can be generated by a spike in power), as FLIPPER will use the points provided by you.

Let's now have a quick look at the output provided by FLIPPER, when it is run for the gradient method alone. 

```{r, eval=F, echo=T}
  print(output.example$gradient)
```
```{r, eval=T, echo=F}
actionButton("action4", label = "Show FLIPPER output")
renderPrint({
  if(input$action4>=1){
    print(output.example$gradient)
    } 
}) 
```

You will see that the output generated contains the selected method and the original input provided by the user. But two columns have been added to the profile; **por**($\phi$) and **tort** ($\theta^2$). These two columns are calculated automatically from the porosity values provided (either as constant or within the **input** dataframe) - as described above. The output also contains a seperate **output** list, which provides you with the diffusive flux where you selected the points (**J.dif.up**), the advective flux at the same location (**J.adv.up**), the integrated reaction rate (**R.int**), and some information related to the linear fit (which is generated by the *lm* function in R). Finally, FLIPPER also returns the environmental parameters (**env.parms**) and specific gradient parameters (**gradient.parms**). In case you did not provide any specific input, these lists will contain the default parameters. The diffusion coefficient (if not provided explicitely) will be calculated using the *diffcoeff* function of CRAN:marelac. 

Now let's go back to our oxygen profile. Using FLIPPER we calculated an oxygen flux of ~8 $mmol \: m^{-2} \: d^{-1}$. What if we now calculate the oxygen flux deeper down in the sediment, for example around 0.3 cm (I will let you choose which points to take)
```{r, eval=F, echo=T}
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         method="gradient")
    plot.FLIPPER(test)
```
```{r, eval=T, echo=F}
actionButton("action5", label = "Run gradient FLIPPER")
renderPlot({
  if(input$action5>=1){
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         method="gradient")
    plot.FLIPPER(test)
    } 
}) 
```
The oxygen flux is now much lower (likely around 2 $mmol \: m^{-2} \: d^{-1}$). If 8 $mmol \: m^{-2} \: d^{-1}$ comes in at the top of the sediment, and only 2 $mmol \: m^{-2} \: d^{-1}$ leaves the sediment at 0.3 cm depth, we have 'lost' ~6 $mmol \: m^{-2} \: d^{-1}$ in those 3 cm. This 'loss' is what has been consumed by microorganisms (and macro/meio organisms, should they be present in your sediment core), we can thus say that the integrated oxygen consumption in the first 0.3 cm of the sediment is ~6 $mmol \: m^{-2} \: d^{-1}$. Should you calculate the oxygen flux at the bottom of your profile (where the O2 concentration is constant and zero), you would get a flux of 0 $mmol \: m^{-2} \: d^{-1}$ (you can try if you don't believe me, simply press 'Run FLIPPER' again above). That means that in the whole sediment column, the total integrated oxygen consumption rate (**R.int**) is (assuming advective transport can be neglected, which it can in unbioturbated sediments)
$$
R_{int}= J_{dif}^{bottom} - J_{dif}^{top} 
$$
and since our diffusive flux at the bottom of our domain is zero,
$$
R_{int}= - J_{dif}^{top} 
$$
which immediately explains why **R.int** in the gradient method is equal to **J.dif.up** (note that this is only valid for species that are completely consumed in the sediment, like - generally - oxygen is). Should you use the gradient function of FLIPPER to calculate gradients at different location of a profile, **R.int** does not mean anything anymore.
We could now theoretically calculate a diffusive flux at different locations in our porewater profile, and this would allow us to delineate different consumption zones. If we want to know the production/consumption rate of a compound at a certain location in the sediment (and not the integrated rate), we should take the derivative of the flux, or
$$
R(x)=\frac{\delta J}{\delta x}
$$
which can be approximated as
$$
R(x)=\frac{\Delta J}{\Delta x}=\frac{J_{dif}^{bottom} - J_{dif}^{top}}{x_{bottom} - x_{top}}
$$
Now, instead of doing this manually for the whole profile, we could also set up a mass balance equation for a dissolved compound in porewater, and fit that to our concentration profile. This is exactly what the discrete method in FLIPPER does, so now it is time to move to the next step.

# The discrete method (diagenetic model fitting)

The discrete method is in essence the original method of the 'PROFILE' program of [@Berg1998], but with some small amendments and extension. FLIPPER will fit the steady state mass balance equation for a porewater solute [@Boudreau1997,@Meysman2005]
$$
 \frac{\delta}{\delta x} \left[\phi D_s \frac{\delta C}{\delta x} - \phi v C_i\right] + \phi \alpha \left( C_0-C\right) +R= 0
$$
where $\phi$ is the porosity, $x$ is the depth coordinate, $C$ is the pore-water concentration, $C_0$ is the bottom-water concentration, $\alpha$ is the bio-irrigation coefficient, $D_s$ is the effective diffusion coefficient of the solute (i.e. corrected for porosity) and $v$ is the advective velocity of the porewater. The original PROFILE did not account for advection $v$, but did include bio-mixing (which we here ignore, as diffusion is much faster). FLIPPER also has the possibility to take into account ionic drift due to an electrical field (which will be discussed in more detail below). We supply all the terms in the equation above to FLIPPER (these are essentially the same parameters as we supplied above for calculating the diffusive flux, aside from the irrigation term $\alpha$), aside from the production profile $R$. The goal is then to find R, so that the modelled $C$ fits our data. The exact procedure to do this is explained in detail in [@Berg1998]. In short, FLIPPER (as PROFILE before him) will divide the sediment in discrete zones with a constant $R$, it will start at 1 and continue to increase the number of zones (2, 3, 4, ..). For each number of zones, FLIPPER will calculate the model cost (as the sum of squared residuals between the modelled concentration profile and supplied data) and evaluate whether increasing the number of zones is statistically improving the model-data fit (it will this for all zone increases, so 1->2, 2->3, 3->4, ...). Once the number of zones is selected, it will check whether combining adjacant zones significantly decreases the model-data fit, and continue lumping zones together until the fit significantly worsens.

The discrete method in FLIPPER can be called as follows

```{r, eval=F, echo=T}
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte,tort.dep=1, 
                         env.parms=env.parms,
                         discrete.parms=discrete.parms,
                         method="discrete")
    plot.FLIPPER(test)
```

We know have an extra (optional) list we can supply **discrete.parms**, which contains parameters specifically for the discrete method. The default parameters for the discrete method are the following

```{r, eval=F, echo=T}
   L.down <- max(input[(input$x>=0.0),"x"]) 
   x.up   <- min(input[(input$x>=0.0),"x"])
   irr    <- 0 
   irr.att<- 0.03
   N      <- 200
   i.end  <- min(12,length(unique(input$x[!is.na(input$C)]))-2)
   initial.zones <- NULL
   prob      <- 0.01
   UBC       <- "conc.up"
   LBC       <- "no.flux"
   flux.up   <- NULL
   flux.down <- NULL
```

But we do not need to worry about those just yet. Let's first analyze our oxygen profile with the default parameters. Just create an empty list (note that you can also just not supply a **discrete.parms** list) and run FLIPPER. 
A pop-up window will appear, for now just supply the value FLIPPER proposes.

```{r, eval=F, echo=T}
  discrete.parms <- list()
  test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         discrete.parms=discrete.parms,
                         method="discrete")
  plot.FLIPPER(test)
```
```{r, eval=T, echo=F}
actionButton("action6", label = "Run discrete FLIPPER")
renderPlot({
  if(input$action6>=1){
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         discrete.parms=discrete.parms,
                         method="discrete")
    plot.FLIPPER(test)
    } 
}) 
```
This immediately illustrates how the discrete method functions, as you can see the discrete production zones (negative production indicates consumption). The red line again shows the model fit to the data. If all went well, you should see FLIPPER now calculated an integrated production rate of -8.669 $mmol \: m^{-2} \: d^{-1}$, which is slightly higher than the gradient approach predicted, but very similar. 

Let's now have a quick look at the output provided by FLIPPER, when it is run for the discrete method alone. 

```{r, eval=T, echo=F}
actionButton("action7", label = "Show FLIPPER output")
renderPrint({
  if(input$action7>=1){
    print(output.example$discrete)
    } 
}) 
```
we still have the **method** and **input** values (the method now obviously shows "discrete"). In the **parms** section we now have **discrete.parms** instead of **gradient.parms**. Aside from the possible input values shown above, FLIPPER also return the depth grid (**grid**), porosity grid (**por.grid**), irrigation grid (**irr.grid**), effective diffusion coefficient grid (**Ds**) and advective velocity grid (**v**). These have been generated using the *setup.grid.1D* function from CRAN:ReacTran, and are just provided for information. 
The **output** list now gives us again the diffusive and advective fluxes at the top of the domain (**J.dif.up**,**J.adv.up**), the fluxes at the bottom of the domain (**J.dif.down**,**J.adv.down**), the volumetric production rate (**R.vol**), the integrated production rate (**R.int**) and the model fit (**fit**). 
The volumetric production rate is given in a table form. The depth is the depth of the beginning of the production zone (the top) and the zone ends at the depth where the layer below starts. So in the example below

```{r, eval=T, echo=T}
print(output.example$discrete$output$R.vol)
```
the first production zone (-2816.59...) runs from depth 0.0 m (the sediment-water interface) to 0.000995 m. The last zone (zone 6) runs from 0.004975 m to the end of the domain. If you want, you can compare these values to the plot above. Note that volumetric production is diven in $mmol \: m^{-3} \: d^{-1}$, since it is the derivative of flux to depth (see above).

By default, FLIPPER sets the boundary condition (**UBC**) to fixed concentration ("conc.up"), and the lower boundary condition (**UBC**) to a no gradient conditions ("no.flux"). You can also set **UBC** to "flux.up", and define a fixed flux in **flux.up**. The **LBC** can be changed to fixed concentration ("conc.down") or fixed flux ("flux.down"), define the flux in **flux.down**. Let's say we are convinced that the is a flux of oxygen going out of the sediment, and that it is 8.0 $mmol \: m^{-2} \: d^{-1}$. We can fill that in in our discrete parameter list (the negative sign indicates an upward flux)

```{r, eval=F, echo=T}
  discrete.parms <- list(UBC="flux.up",LBC="conc.down",flux.up=-8.0)
  test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                       env.parms=env.parms,
                       discrete.parms=discrete.parms,
                       method="discrete")
  plot.FLIPPER(test)
```
and then we run FLIPPER

```{r, eval=T, echo=F}
actionButton("action8", label = "Run discrete FLIPPER")
renderPlot({
  if(input$action8>=1){
    discrete.parms <- list(UBC="flux.up",LBC="conc.down",flux.up=-8.0)
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         discrete.parms=discrete.parms,
                         method="discrete")
    plot.FLIPPER(test)
    } 
}) 
```
You will see that FLIPPER tried really hard to fit the profile with an upward flux out of the sediment. While this example does not make much sense, it could help to change the boundary conditions if FLIPPER is not able to find a good fit to your concentration profile with the given boundary conditions. Sometimes you can have a profile with a clear gradient at the bottom of the domain, in that case it makes sens to change **LBC** to "C.down". 
Other parameters that could be changed are **L.down** and **x.up**, which define the top and bottom of the profile that should be analyzed by FLIPPER, for example - say we only want to analyze the data down to 0.3 cm depth (Note that changing the **x.up** parameter is a bit more sensitive and might lead to FLIPPER crashing);
```{r, eval=F, echo=T}
  discrete.parms <- list(L.down=0.003)
  test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                       env.parms=env.parms,
                       discrete.parms=discrete.parms,
                       method="discrete")
  plot.FLIPPER(test)
```
```{r, eval=T, echo=F}
actionButton("action9", label = "Run discrete FLIPPER")
renderPlot({
  if(input$action9>=1){
    discrete.parms <- list(L.down=0.003)
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         discrete.parms=discrete.parms,
                         method="discrete")
    plot.FLIPPER(test)
    } 
}) 
```
what happens now is that we get many more zones. The reason for this is that FLIPPER will fit 12 zones on the 0.0 - 0.3 cm depth interval instead of the 0.0 - 1.0 cm depth interval. Because there are more zones, FLIPPER will be fitting much shorter segments of the concentration profile, which might lead to more noise in your production profile (as you can see - for example - from the production zone at depth). You are able to manipulate the number of zones FLIPPER uses via the **i.end** and **initial.zones** parameters. **i.end** tells FLIPPER the maximum number of zones he needs to test initially, whereas **initial.zones** tells FLIPPER to immediately start the lumping process from a given number of zones. For example;
```{r, eval=F, echo=T}
  discrete.parms <- list(i.end=3)
  test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                       env.parms=env.parms,
                       discrete.parms=discrete.parms,
                       method="discrete")
  plot.FLIPPER(test)
```
```{r, eval=T, echo=F}
actionButton("action10", label = "Run discrete FLIPPER")
renderPlot({
  if(input$action10>=1){
    discrete.parms <- list(i.end=3)
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         discrete.parms=discrete.parms,
                         method="discrete")
    plot.FLIPPER(test)
    } 
}) 
```
and
```{r, eval=F, echo=T}
  discrete.parms <- list(initial.zones=5)
  test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                       env.parms=env.parms,
                       discrete.parms=discrete.parms,
                       method="discrete")
  plot.FLIPPER(test)
```
```{r, eval=T, echo=F}
actionButton("action11", label = "Run discrete FLIPPER")
renderPlot({
  if(input$action11>=1){
    discrete.parms <- list(initial.zones=5)
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         discrete.parms=discrete.parms,
                         method="discrete")
    plot.FLIPPER(test)
    } 
}) 
```
The parameters related to irrigation **irr** and **irr.att** will be discussed below. The parameters **prob** tells the confidence interval at which to reject the null hypothesis. While we do not recommend to change this value, increasing it will generally lead to a higher numbe of zones. Parameter **N** is the number of depth layers the diagenetic model should take into account, and should not be changed.

We can now take our analysis a step further. As discussed above, the discrete analysis tries to find a solution to the steady-state mass-balance equation
$$
 \frac{\delta}{\delta x} \left[\phi D_s \frac{\delta C}{\delta x} - \phi v C\right] + \phi \alpha \left( C_0-C\right) +R= 0
$$
If we ignore irrigation for now (this is not straight forward to quantify in marine sediments, and needs special consideration - we refer to [@THIBAULTDECHANVALON201734] for a more detailed discussion), we know that transport of a dissolved species in porewater can be calculated as
$$
 J=-\phi D_s \frac{\delta C}{\delta x} + \phi v C
$$
and if we assume steady-state, production can be calculated as
$$
 R=-\frac{\delta}{\delta x} \left[\phi D_s \frac{\delta C}{\delta x} - \phi v C\right] 
$$
or, if we work out the differential equation
$$
R=-\phi D_s \frac{\delta^2 C}{\delta x^2}-D_s\frac{\delta \phi}{\delta x}\frac{\delta C}{\delta x}-\phi \frac{\delta D_s}{\delta x}\frac{\delta C}{\delta x}+\phi v \frac{\delta C}{\delta x} + v C\frac{\delta \phi}{\delta x}+\phi C\frac{\delta v}{\delta x} \\
= -\phi D_s \frac{\delta^2 C}{\delta x^2}-\left(D_s\frac{\delta \phi}{\delta x}+\phi \frac{\delta D_s}{\delta x}- \phi v\right)\frac{\delta C}{\delta x}+\left(v \frac{\delta \phi}{\delta x} +\phi \frac{\delta v}{\delta x}\right)C
$$
For our oxygen profile, we can assume that the porosity is constant with depth (no change over the first 0.5 cm), and so $\frac{\delta \phi}{\delta x}$ is zero. For a dissolved compound, diffusional transport is much faster than advective transport, and so we can ignore $v$ and $\frac{\delta v}{\delta x}$. Finally, we can assume that salinity and temperature is constant in the first 0.5 cm, and since porosity is also constant, $\frac{\delta D_s}{\delta x}$ is zero. So our equation for $R$ simplifies to
$$
R= -\phi D_s \frac{\delta^2 C}{\delta x^2}
$$
which shows that if we can find the first and second derivatives of the concentration profile, we can directly calculate transport and production. It is this approach that is used in the continuous FLIPPER method.

# The continuous method (first and second derivative calculation)

The continuous method will derive the first and second derivative of a given concentration profile, and use that to calculate transport and production. One issue with experimental data is noise. We saw before that a higher number of zones can lead to fluctuations between positive and negative production zones when running the discrete method. One way of dealing with noise is smoothing your data. In the continuous method, we pass a window over the concentration profile, and fit a polynomial through it, and then calculate the first and second derivative of the polynomial at each point. The filter employed is a Savitzky-Golay filter, which is use a lot in analysis of spectra [@Savitzky1964]. The critical point for this analysis is the filter window. If we choose too narrow a filter window (defined by parameter **n**, a window will be created of n points before and after the point of interest, so a total of 2n+1), we will capture too much noise. If we choose too large a window, we will smooth too much. 
You can explore the effect of the smoothing window on your output by changing the **n** below. Remember that **n** indicates the number of points left and right of the center point, so the actual window is 2n+1. 

```{r, eval=T, echo=F}
sliderInput("n.C", label = "Smoothing window (n):",
              min = 2, max = 40, value = 2, step = 1)
renderPlot({
    continuous.parms <- list(n.C=input$n.C,n.J=input$n.C,n.R=input$n.C)
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         continuous.parms=continuous.parms,
                         method="continuous")
    plot.FLIPPER(test)
})
```

You will see that when the filter window is too low, we capture every twist and turn in the profiles and there is a lot of noise in the production profile. On the other hand, if we smooth too much, we are missing important features. For example, the sharp decrease in gradient at 0.4 cm is missed because the smoothing window takes into account too many of the higher concentration points. It is thus important to find the right smoothing window. You will also notice that the production profile predicted by the continuous method in FLIPPER is very similar as for the discrete method, which is what we would like (otherwise the diagenetic theory would be having issues :o)). 

When you run FLIPPER interactive (the default mode), you will be show three different pop-up windows where you will have to click on the 'break-point', this is where the curve stops decreasing and levels off (preferably at a value of 1). This break-point should be the optimal filter window. You will notice that (in general) the optimal filter window becomes higher for the higher order derivatives - so for C it is around 3 or 4, for the flux $J$ (the first derivative $\frac{\delta C}{\delta x}$) it is around 6, and for the production profile $R$ (the second derivative $\frac{\delta^2 C}{\delta x^2}$), it is around 15. The need to smooth more with higher order derivatives is simply a consequence of the increasing noise level (the uncertainty becomes progressively larger). When you select these points, you will notice that this way of selecting the breakpoints is not water-tight; there are still a lot of noise squiggles in the concentration profile.
Another question that is not straight-forward to answer is whether you need to use the same filter window for $C$, $\frac{\delta C}{\delta x}$ and $\frac{\delta^2 C}{\delta x^2}$. You could argue that you should, since you want to calculate the derivatives of the same concentration profile, and if you change smoothing windows, the plotted model fit will not link to the plotted transport and production rates. On the other hand, higher order derivative introduce more noise, so it makes sense you have to increase the smoothing window for these derivatives, and you don't want to oversmooth the lower order derivatives. While it is important to be aware of these issues, choose different smoothing windows for $J$ and $R$ will not significantly affect your results. By default, FLIPPER sets the filter window uniformally, so all **n** values are set to the highest selected **n** (which will generally be the one selected for $R$). FLIPPER can also automatically select a filter size, but this function is a bit sensitive and has the tendency to crash (so this needs a bit more development). For now, we will not discuss the other options for the continuous method, as the default settings are the best ones to use.

```{r, eval=F, echo=T}
  continuous.parms <- list(optimal.window.size="interactive",n.uniform=FALSE)
  test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                       env.parms=env.parms,
                       continuous.parms=continuous.parms,
                       method="continuous")
  plot.FLIPPER(test)
```
```{r, eval=T, echo=F}
actionButton("action12", label = "Run continuous FLIPPER")
renderPlot({
  if(input$action12>=1){
    continuous.parms <- list(optimal.window.size="interactive",n.uniform=FALSE)
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         continuous.parms=continuous.parms,
                         method="continuous")
    plot.FLIPPER(test)
    } 
}) 
```

As a final point we will look at the output of the continuous method, 

```{r, eval=T, echo=F}
actionButton("action13", label = "Show FLIPPER output")
renderPrint({
  if(input$action13>=1){
    print(output.example$continuous)
    } 
}) 
```

We still have the method and input values (the method now obviously shows “continuous”). The input section now also contains a **continuous.input** dataframe, which contains the input as it is processed for the continuous approach. The smoothing procedure needs equally spaced data, so FLIPPER interpolates the supplied data. There are also columns for the first derivatives of the porosity, diffusion coefficient and advection velocity. These are zero by default, but can also be supplied in the user-input dataframe (columns **dpor_dx**, **dDs_dx** and **dv_dx**). The output dataframe looks very similar as when you have run the discrete method, but it now contains continuous profiles for the diffusive flux J.dif, the advective flus J.adv and the volumetric production rate. And then finally there are the parameter lists.

Should you want to run all three methods at the same time, you can set the **method** to "all" or NULL. FLIPPER will then run through all three methods, and supply you with a combination of the output of the individual methods. You can then easily plot all three methods next to each other using the *plot.FLIPPER* function, which allows for a comparison of the different methods.

```{r, eval=F, echo=T}
gradient.parms <- c()
discrete.parms <- list()
continuous.parms <- list(optimal.window.size="interactive",n.uniform=TRUE)
test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                     env.parms=env.parms,
                     gradient.parms=gradient.parms,
                     discrete.parms=discrete.parms,
                     continuous.parms=continuous.parms,
                     method="all")
plot.FLIPPER(test)
```

```{r, eval=T, echo=F, fig.dim = c(18,8)}
plot.FLIPPER(output.example$all)
```

# Specific cases

## Electro-active sediments

Under construction

## Irrigated sediments

Under construction

#references


