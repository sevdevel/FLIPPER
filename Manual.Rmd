---
runtime: shiny
output: html_document
#output: pdf_document
bibliography: "DOC/FLIPPERDOC.bib"
title: "FLIPPER: Flexible Interpretation of Porewater Profiles and Estimation of Rates"
---

<center>
![Logo](DOC/FLIPPERDOC_Figures/Logo_FLIPPER.png)
</center>

# Introduction

FLIPPER (short for: FLexible Interpretation of Porewater Profiles and Estimation of Rates) has been created to provide a flexible way to analyze porewater data in sediments, continuing from the initial work of [@Berg1998]. The goal is to be able to extract fluxes in/out of the sediment, and net production or consumption rates from a vertical porewater profile. FLIPPER provides three different ways to analyze porewater data:

* calculation of a diffusive flux
* fitting of a simple diagenetic profile (cfr [@Berg1998])
* calculation of the first and second derivatives of a concentration profile

All three of these methods are combined in a simple R-function *FLIPPER_func*. In this manual, we will go through all three approaches and show how they can be calculated using FLIPPER.

# Preparatory steps
## Preparing your R environment
The first step is to install all required packages (tcltk is commented out because it is a base package and should be installed already):
```{r}
##install.packages("tcltk")
#install.packages("marelac")
#install.packages("ReacTran")
#install.packages("FME")
#install.packages("signal")
#install.packages("fractaldim")
```
and - provided they have are all installed properly - we can now source the two main functions
```{r}
source("user interface function.R", local = knitr::knit_global())
source("FLIPPER_plotfunction.R", local = knitr::knit_global())
```

## The FLIPPER function
We can take a quick first look at the syntax of the FLIPPER function (but we will go in more depth later)
```{r, eval=F, echo=T}
FLIPPER.func(input,species,por.cte=NA,E.cte=NULL,tort.dep=1,method=NULL,env.parms=NULL,full.output=FALSE,
             # optional input for gradient
             gradient.parms=NULL
             # optional input for discrete
             discrete.parms=NULL,
             # optional input for continuous
             continuous.parms=NULL,
             )
```
We can see that FLIPPER requires **input** (your data) and a species (which element are you analyzing), and can optionally be supplied with porosity (**por.cte**), electrical field (**E.cte**), a choice of tortuosity (**tort.dep**, more on that later), which method (**method**), a set of environmental parameters (**env.parms**), whether you want all possible output (**full.output**). Finally there is also the possibility to supply specific parameters for each of the three analysis methods (**gradient.parms**, **discrete.parms**, **continuous.parms**). Through a series of example analyses of porewater profiles, we will discuss the different types of input, how to use FLIPPER, and part of the theory behind FLIPPER.

## Preparing a dataset
Now we want to load a dataset to work with 
```{r}
load("datasets to test/O2_testprofiles.RData", envir = knitr::knit_global())
```

This will load three different O2 profile, called *profile.A*, *profile.B* and *profile.C*. All three of them are dataframes, and have an identical structure. You can look at the top of profile.A
```{r}
head(profile.A)
```
you will notice there are 8 different columns. These three oxygen profiles are artificially generated, which means we have applied a depth-dependent reaction rate, and calculated the concentration and transport profiles. Hence, the columns **C.true**, **J.true** and **R.true** are the simulated profiles. Afterwards we have added noise to the data (column **C**), and have generated an artificial oxygen profile. For the purpose of this exercise, we only have to look at columns **x** and **C**. Column **x** represents the depth (in centimeters) and column **C** the concentration (in mM). You can imagine this is data generated by analyzing oxygen in marine sediments using microsensor profiling. 
The units of FLIPPER are $m$ (for **x**) and $mmol \: m^{-3}$ (for **C**). The first thing we have to do is to create a dataframe **input** with the right columns (and with the data in the right units), so it can be analyzed by FLIPPER. 
```{r}
input.profile <- as.data.frame(cbind(profile.A$C*1e3,profile.A$x*1e-2))
colnames(input.profile) <- c('C','x')
```
The resulting input dataframe then looks like this
```{r}
head(input.profile)
```

The next thing we have to tell FLIPPER are the environmental conditions in which we measured our porewater profiles. For our case, this would be 10.0 $Â° C$ for the temperature (**TC**) and 35.0 for the salinity (**S**). So we make a list with those values.
```{r}
env.parms <- list(TC=10.0,S=35.0)
```
And finally, we have to supply the porosity of the sediment. This can be done directly in the **input** dataframe, if we have a depth-dependent porosity profile, or as a constant value. Since the porosity will not vary much over the first 0.5 cm of the sediment, we can just supply a constant value.
```{r}
por.cte <- 0.8
```
Now we have the essential data to analyze our porewater $O_2$ profile. Let's start using FLIPPER.

# The gradient method
We supply our **input** dataframe, **por.cte** value and **env.parms** list to FLIPPER, and indicate we are analyzing an oxygen profile (c("O2") in the FLIPPER function). 
```{r, eval=F, echo=T}
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
                         env.parms=env.parms,
                         method="gradient")
```
Once we run FLIPPER via the action button below, a pop-up window will appear and ask us to select the two points between which we want to calculate the diffusive flux. To calculate a gradient, we need to fit a linear model through the concentration versus depth plot. The slope of this fit then gives us the concentration gradient. To have a robust estimate of the slope, it is important to select at least 3 points (and preferably more) points. Let's first select the first four points on the concentration profile (so the four points closest to the sediment-water interface).
Whenever you are ready, press the button below to run FLIPPER.

```{r, eval=T, echo=F}
actionButton("action", label = "Run FLIPPER")
renderPlot({
  if(input$action>=1){
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
             env.parms=env.parms,
             method="gradient")
    plot.FLIPPER(test)
  } 

}) 
```

If all went well, FLIPPER calculated for us a diffusive oxygen flux of 8.012 $mmol \: m^{-2} \: d^{-1}$ (the minus indicates the flux is from the water column to the sediment). 
An alternative way of calculating an oxygen flux into the sediment is by calculating the diffusive oxygen flux in the water column, through the so-called Diffusive Boundary Layer. In this layer just above the sediment-water interface, advection is not efficient, and diffusion is the dominant transport pathway for dissolved substances. For more in depth reading about the DBL and its impact on O2 fluxes, you can refer to [@Jorgensen1990] and many other publications on this subject.
For now, all you need to know is that the flux of O2 through the DBL should be equal to the flux of O2 into the sediment. We can test this by running FLIPPER again, and this time select the first point just above the SWI, and the 6th point above the SWI (where the constant concentration of O2 starts decreasing).

```{r, eval=T, echo=F}
actionButton("action2", label = "Run FLIPPER")
renderPlot({
  if(input$action2>=1){
    test <- FLIPPER.func(input=input.profile,species=c("O2"),por.cte=por.cte, 
             env.parms=env.parms,
             method="gradient")
    plot.FLIPPER(test)
  } 

}) 
```

If all went well, FLIPPER calculated for us a diffusive oxygen flux of 7.536 $mmol \: m^{-2} \: d^{-1}$, which, given the uncertainty associated with the measurements, is pretty close to the oxygen flux estimated from the first sediment layer.



# The discrete method (diagenetic model fitting)

 This is because they generally fit the steady state mass balance equation
$$
 \frac{\delta}{\delta x} \left[\phi\left(D_s+D_B \right) \frac{\delta C}{\delta x}\right] + \phi \alpha \left( C_0-C\right) +R= 0
$$
where $\phi$ is the porosity, $x$ is the depth coordinate, $C$ is the pore-water concentration, $C_0$ is the bottom-water concentration, $\alpha$ is the bio-irrigation coefficient, $D_s$ is the effective diffusion coefficient of the solute (i.e. corrected for porosity) and $D_B$ is the bio-diffusion coefficient. 

The problem for electro-active sediments is that dissolved ions also undergo advection due to the electrical field \cite{RisgaardPetersen2012}. In these sediments, the flux of an ion is given by the Nernst-Planck equation \cite{RisgaardPetersen2012}



# The continuous method (first and second derivative calculation)




#references


